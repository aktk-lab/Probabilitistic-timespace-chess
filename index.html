<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probabilistic‑Timespace‑Chess – 2盤並列・レスポンシブ</title>
  <style>
    :root { --bg:#0b0d10; --card:#131720; --text:#e7edf5; --muted:#9fb2c9; --accent:#6aa3ff; }
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif }
    .container{max-width:1100px; margin:20px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width: 720px){ .grid{ grid-template-columns:1fr } }
    .card{ background:var(--card); border:1px solid #1f2633; border-radius:16px; padding:16px }
    .title{ font-size:18px; font-weight:700; margin-bottom:8px }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px }
    input{ background:#0f141c; color:var(--text); border:1px solid #283248; border-radius:10px; padding:10px 12px }
    button{ background:var(--accent); color:#08111f; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }/* --- 盤 --- */
.board{ display:grid; grid-template-columns:repeat(8, 1fr); gap:2px; width:100% }
.sq{ aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size: clamp(18px, 4.2vw, 28px); border-radius:6px; user-select:none; transition: box-shadow .15s ease }
.light{ background:#d8dee9; color:#2e3440 }
.dark{ background:#4c566a }
.sq.highlight-from{ outline:3px solid #ffd166; box-shadow: inset 0 0 0 2px #ffd166 }
.sq.highlight-to{ outline:3px solid #06d6a0; box-shadow: inset 0 0 0 2px #06d6a0 }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/chess.min.js"></script>
</head>
<body>
  <div class="container">
    <h1 style="margin:0 0 10px 0">Probabilistic‑Timespace‑Chess</h1><div class="controls">
  <input id="moveSan" placeholder="例: e4, Nf3, Bb5+" />
  <button id="btnMove">指す</button>
  <button id="btnReset">リセット</button>
</div>

<div class="grid">
  <div class="card">
    <div class="title">Board A（実体）</div>
    <div id="boardA" class="board"></div>
  </div>
  <div class="card">
    <div class="title">Board B（確率投影）</div>
    <div id="boardB" class="board"></div>
  </div>
</div>

  </div>  <script>
    const pieces = { p:'♟', r:'♜', n:'♞', b:'♝', q:'♛', k:'♚', P:'♙', R:'♖', N:'♘', B:'♗', Q:'♕', K:'♔' };
    let game = new Chess();
    let seed = 12345;               // 投影の乱数シード
    let lastMove = null;            // {from:'e2', to:'e4'} を保持してハイライト

    function mulberry32(a){
      return function(){
        let t = (a += 0x6D2B79F5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function drawBoard(container, fen, probabilistic=false, highlights=null){
      container.innerHTML = '';
      const rng = mulberry32(seed + game.history().length);
      const rows = fen.split(' ')[0].split('/');
      rows.forEach((row,r)=>{
        let expanded = '';
        for (const ch of row){
          if(/[1-8]/.test(ch)) expanded += ' '.repeat(parseInt(ch)); else expanded += ch;
        }
        for (let c=0;c<8;c++){
          const sq = document.createElement('div');
          sq.className = 'sq ' + ((r+c)%2?'dark':'light');
          const file = 'abcdefgh'[c];
          const rank = 8 - r;
          const name = file + rank;
          if (highlights){
            if (highlights.from === name) sq.classList.add('highlight-from');
            if (highlights.to === name) sq.classList.add('highlight-to');
          }
          let ch = expanded[c];
          if(probabilistic && /[prnbqkPRNBQK]/.test(ch)){
            if(rng() < 0.22) ch = '?';
          }
          sq.textContent = pieces[ch] || (ch==='?'?'?':'');
          container.appendChild(sq);
        }
      });
    }

    function render(){
      const fen = game.fen();
      drawBoard(document.getElementById('boardA'), fen, false, lastMove);
      drawBoard(document.getElementById('boardB'), fen, true,  lastMove);
    }

    document.getElementById('btnMove').addEventListener('click', ()=>{
      const san = document.getElementById('moveSan').value.trim();
      if(!san) return;
      try{
        const mv = game.move(san, { sloppy:true });
        if(!mv){ alert('不正な手: '+san); return; }
        lastMove = { from: mv.from, to: mv.to };
        render();
      }catch(e){ alert('不正な手: '+san); }
      document.getElementById('moveSan').value='';
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      game = new Chess();
      lastMove = null;
      render();
    });

    render();
  </script></body>
</html>
