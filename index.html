<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>確率投影チェス（現実A／影B）</title>
<style>
:root{--bg:#0b0f14;--card:#121821;--muted:#90a4b8;--text:#e9eef6;--btn:#1b2533;
      --sqL:#e9d8a6;--sqD:#1d4d4f;--sel:#ffd166;--accent:#6ca6ff;--w:#ffd86b;--b:#6bd3ff}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{padding:14px;display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;align-items:center}
button{background:#1b2533;color:#e9eef6;border:1px solid #26344a;border-radius:12px;padding:9px 12px}
input[type=range]{width:180px}
.boards{display:grid;gap:12px}
@media(min-width:720px){.boards{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid #1f2a3b;border-radius:14px;padding:10px}
.board{display:grid;grid-template-columns:repeat(8,1fr);border:2px solid #29364a;border-radius:10px;overflow:hidden;max-width:92vw;margin:0 auto;touch-action:manipulation}
.sq{width:11.5vw;height:11.5vw;max-width:66px;max-height:66px;display:flex;align-items:center;justify-content:center;font-size:28px;position:relative;user-select:none}
.light{background:var(--sqL)} .dark{background:var(--sqD)}
.sel{outline:3px solid var(--accent);outline-offset:-3px}
.legal::after{content:"";position:absolute;inset:6px;border:3px dashed var(--sel);border-radius:6px}
.p{filter:drop-shadow(0 1px 0 #0008) drop-shadow(0 2px 4px #0006)}
.w{color:var(--w)} .b{color:var(--b)}
.ghost{opacity:.7;text-shadow:0 0 8px #fff8}
.badge{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h2>確率投影チェス（現実A／影B）</h2>
  <div class="row">
    <button id="ai">Vs ランダムAI：ON</button>
    <button id="project">Project：OFF</button>
    <button id="shadowMove">影を操作：OFF</button>
    <button id="collapse">Collapse（影→現実）：OFF</button>
    <label class="badge">成功確率 <span id="pLab">60</span>% <input id="pRange" type="range" min="10" max="90" value="60"></label>
    <button id="reset">リセット</button>
  </div>
  <div class="boards">
    <div class="card"><h3>A（現実）</h3><div id="A" class="board"></div></div>
    <div class="card"><h3>B（影）</h3><div class="badge">影（ゴースト）を動かしてCollapseで具現化</div><div id="B" class="board"></div></div>
  </div>
  <div class="card"><div id="status">White to move</div></div>
</div>
<script>
const GL={wK:'♔',wQ:'♕',wR:'♖',wB:'♗',wN:'♘',wP:'♙',bK:'♚',bQ:'♛',bR:'♜',bB:'♝',bN:'♞',bP:'♟'};
let NEXT_ID=1;
const empty8=()=>Array.from({length:8},()=>Array(8).fill(null));
const in8=(r,c)=>r>=0&&r<8&&c>=0&&c<8;
const clone=b=>b.map(r=>r.slice());
function start(){
  const A=empty8(), B=empty8();
  const back=['R','N','B','Q','K','B','N','R'];
  for(let c=0;c<8;c++){ A[6][c]=mk('w','P'); A[1][c]=mk('b','P'); }
  for(let c=0;c<8;c++){ A[7][c]=mk('w',back[c]); A[0][c]=mk('b',back[c]); }
  return {A,B};
}
function mk(color,type,id){ return {color,type,id:id||NEXT_ID++}; }
function glyph(p){ return GL[p.color+p.type]; }
function rays(board,r,c,dirs,side){const out=[];for(const[dr,dc]of dirs){let nr=r+dr,nc=c+dc;while(in8(nr,nc)){const t=board[nr][nc];if(!t)out.push([nr,nc]);else{if(t.color!==side)out.push([nr,nc]);break;}nr+=dr;nc+=dc;}}return out;}
function steps(board,r,c,ds,side){const out=[];for(const[dr,dc]of ds){const nr=r+dr,nc=c+dc;if(!in8(nr,nc))continue;const t=board[nr][nc];if(!t||t.color!==side)out.push([nr,nc]);}return out;}
function pawn(board,r,c,side){const out=[];const d=side==='w'?-1:1;const f=r+d;if(in8(f,c)&&!board[f][c])out.push([f,c]);for(const dc of[-1,1]){const nr=r+d,nc=c+dc;if(!in8(nr,nc))continue;const t=board[nr][nc];if(t&&t.color!==side)out.push([nr,nc]);}return out;}
function legal(board,r,c){const p=board[r][c];if(!p)return[];switch(p.type){case'P':return pawn(board,r,c,p.color);case'N':return steps(board,r,c,[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],p.color);case'B':return rays(board,r,c,[[-1,-1],[-1,1],[1,-1],[1,1]],p.color);case'R':return rays(board,r,c,[[-1,0],[1,0],[0,-1],[0,1]],p.color);case'Q':return rays(board,r,c,[[-1,-1],[-1,1],[1,-1],[1,1],[-1,0],[1,0],[0,-1],[0,1]],p.color);case'K':return steps(board,r,c,[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],p.color);}return[];}
function promoteIfNeeded(p,r){if(p.type!=='P')return p; if(p.color==='w'&&r===0)return mk('w','Q',p.id); if(p.color==='b'&&r===7)return mk('b','Q',p.id); return p;}
const Ael=document.getElementById('A'), Bel=document.getElementById('B'), st=document.getElementById('status');
const aiBtn=document.getElementById('ai'), projBtn=document.getElementById('project'), shBtn=document.getElementById('shadowMove'), colBtn=document.getElementById('collapse');
const pRange=document.getElementById('pRange'), pLab=document.getElementById('pLab'); pRange.oninput=()=>pLab.textContent=pRange.value;
let G=start(), turn='w', winner=null, ai=true, project=false, shadowMode=false, collapseMode=false, pick=null, moves=[], pickBoard='A';
aiBtn.onclick=()=>{ai=!ai; aiBtn.textContent='Vs ランダムAI：'+(ai?'ON':'OFF');}
projBtn.onclick=()=>{project=!project; projBtn.textContent='Project：'+(project?'ON':'OFF');}
shBtn.onclick=()=>{shadowMode=!shadowMode; collapseMode=false; shBtn.textContent='影を操作：'+(shadowMode?'ON':'OFF'); colBtn.textContent='Collapse（影→現実）：OFF';}
colBtn.onclick=()=>{collapseMode=!collapseMode; shadowMode=false; colBtn.textContent='Collapse（影→現実）：'+(collapseMode?'ON':'OFF'); shBtn.textContent='影を操作：OFF';}
document.getElementById('reset').onclick=()=>{G=start();turn='w';winner=null;pick=null;moves=[];draw();}
function winCheck(){let wk=false,bk=false;for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=G.A[r][c];if(p?.type==='K'){if(p.color==='w')wk=true;else bk=true;}}if(!wk)return'Black';if(!bk)return'White';return null;}
function draw(){
  st.textContent=winner?winner+' wins!':(turn==='w'?'White':'Black')+' to move';
  drawBoard(Ael,G.A,true,'A'); drawBoard(Bel,G.B,true,'B');
}
function drawBoard(root,board,interactive,which){
  root.innerHTML='';
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const b=document.createElement('button'); b.className='sq '+(((r+c)%2)?'dark':'light');
    const p=board[r][c];
    if(p){ const s=document.createElement('span'); s.textContent=glyph(p); s.className='p '+(p.color==='w'?'w':'b')+(which==='B'?' ghost':''); b.appendChild(s); }
    if(pick&&pickBoard===which&&pick.r===r&&pick.c===c) b.classList.add('sel');
    if(pick&&pickBoard===which&&moves.some(([rr,cc])=>rr===r&&cc===c)) b.classList.add('legal');
    b.onclick=()=>tap(which,r,c);
    root.appendChild(b);
  }
}
function findPieceById(board,id){for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=board[r][c];if(p?.id===id)return[r,c];}return null;}
function tap(which,r,c){
  if(winner) return;
  if(which==='B' && collapseMode){ const g=G.B[r][c]; if(!g) return;
    // 具現化：確率p%で成功 → Aの同IDを同座標へテレポート
    const id=g.id, pos=findPieceById(G.A,id); if(!pos){ G.B[r][c]=null; draw(); return; } // 本体消滅してたら影を消す
    const roll=Math.random()*100 < parseInt(pRange.value,10);
    if(roll){
      // 空 or 敵ならOK、自駒なら不可（影は残す）
      const t=G.A[r][c];
      if(t && t.color===g.color){ st.textContent='同陣で塞がれているため具現化できません'; draw(); return; }
      const [ar,ac]=pos; const cap=G.A[r][c];
      G.A[r][c]=promoteIfNeeded(G.A[ar][ac], r); G.A[ar][ac]=null; G.B[r][c]=null;
      if(cap?.type==='K'){ winner=g.color==='w'?'White':'Black'; draw(); return; }
      turn = (turn==='w'?'b':'w'); winner=winCheck(); draw(); maybeAI(); return;
    }else{
      G.B[r][c]=null; st.textContent='具現化失敗（影は消滅）'; draw(); return;
    }
  }
  const board = which==='A'? G.A : G.B;
  const isMyTurn = (turn=== (board[r][c]?.color||turn));
  if(!pick){
    if(board[r][c]){
      if(which==='A' && board[r][c].color===turn && !shadowMode){
        pick={r,c}; pickBoard='A'; moves=legal(G.A,r,c); draw();
      }else if(which==='B' && board[r][c].color===turn && shadowMode){
        pick={r,c}; pickBoard='B'; moves=legal(G.B,r,c); draw();
      }
    }
    return;
  }
  if(pickBoard!==which){ pick=null;moves=[];draw();return; }
  const ok=moves.some(([rr,cc])=>rr===r&&cc===c);
  if(!ok){
    if(board[r][c] && board[r][c].color===turn){
      pick={r,c}; moves=legal(board,r,c); draw();
    }else{ pick=null;moves=[];draw(); }
    return;
  }
  // 実行
  const [sr,sc]=[pick.r,pick.c];
  const mv=board[sr][sc]; const cap=board[r][c];
  board[r][c]=promoteIfNeeded(mv,r); board[sr][sc]=null;
  if(which==='A'){
    if(project){ // 影を生成（同IDで）
      if(!G.B[r][c]) G.B[r][c]={...board[r][c],ghost:true}; // ゴースト：同ID
    }
    if(cap?.type==='K'){ winner = (turn==='w'?'White':'Black'); draw(); return; }
    G.A=board; endTurn();
  }else{ // 影を動かしただけ
    G.B=board; pick=null;moves=[]; draw();
  }
}
function endTurn(){ pick=null;moves=[]; turn=(turn==='w'?'b':'w'); winner=winCheck(); draw(); maybeAI(); }
function allMovesA(color){const out=[];for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=G.A[r][c];if(p&&p.color===color){for(const [nr,nc] of legal(G.A,r,c)){out.push([r,c,nr,nc]);}}}return out;}
function maybeAI(){ if(!ai||winner||turn!=='b')return; setTimeout(()=>{ const ms=allMovesA('b'); if(!ms.length){winner='White';draw();return;} const m=ms[Math.random()*ms.length|0]; const [r,c,nr,nc]=m; const cap=G.A[nr][nc]; G.A[nr][nc]=promoteIfNeeded(G.A[r][c],nr); G.A[r][c]=null; if(cap?.type==='K'){winner='Black';draw();return;} turn='w'; draw(); },220); }
draw();
</script>
</body>
</html>
