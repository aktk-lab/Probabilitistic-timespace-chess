<!doctype html>

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probabilistic‑Timespace‑Chess</title>
  <style>
    body { margin:0; background:#0b0d10; color:#e7edf5; font-family:system-ui, sans-serif; }
    .container{ max-width:1000px; margin:20px auto; padding:0 16px; }
    h1{ margin-bottom:10px; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    input, button{ padding:8px 12px; border-radius:8px; border:1px solid #333; }
    button{ background:#6aa3ff; color:#08111f; font-weight:bold; cursor:pointer; }
    .boards{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media(max-width:700px){ .boards{ grid-template-columns:1fr; } }
    .card{ background:#131720; border-radius:12px; padding:12px; }
    .title{ font-weight:bold; margin-bottom:8px; }.board{ display:grid; grid-template-columns:repeat(8,1fr); gap:2px; }
.square{ aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:4px; }
.light{ background:#d8dee9; color:#2e3440; }
.dark{ background:#4c566a; }
.highlight-from{ outline:3px solid #ffd166; }
.highlight-to{ outline:3px solid #06d6a0; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/chess.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Probabilistic‑Timespace‑Chess</h1>
    <div class="controls">
      <input id="moveSan" placeholder="例: e4, Nf3" />
      <button id="btnMove">指す</button>
      <button id="btnReset">リセット</button>
      <label>Seed: <input id="seed" type="number" value="12345"></label>
    </div>
    <div class="boards">
      <section class="card">
        <div class="title">Board A（実体）</div>
        <div id="boardA" class="board"></div>
      </section>
      <section class="card">
        <div class="title">Board B（確率投影）</div>
        <div id="boardB" class="board"></div>
      </section>
    </div>
  </div>  <script>
    const pieces = { p:'♟', r:'♜', n:'♞', b:'♝', q:'♛', k:'♚', P:'♙', R:'♖', N:'♘', B:'♗', Q:'♕', K:'♔' };
    let game = new Chess();
    let lastMove = null;
    let seed = 12345;

    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function renderBoard(container, fen, probabilistic=false){
      container.innerHTML = '';
      const rng = mulberry32(seed + game.history().length);
      const rows = fen.split(' ')[0].split('/');
      rows.forEach((row, r)=>{
        let expanded = '';
        for(const ch of row){
          expanded += /[1-8]/.test(ch)? ' '.repeat(+ch) : ch;
        }
        for(let c=0;c<8;c++){
          const sq = document.createElement('div');
          sq.className = 'square ' + ((r+c)%2?'dark':'light');
          const file = 'abcdefgh'[c];
          const rank = 8 - r;
          const name = file+rank;
          if(lastMove){
            if(lastMove.from===name) sq.classList.add('highlight-from');
            if(lastMove.to===name) sq.classList.add('highlight-to');
          }
          let ch = expanded[c];
          if(probabilistic && /[prnbqkPRNBQK]/.test(ch)){
            if(rng()<0.2) ch = '?';
          }
          sq.textContent = pieces[ch] || (ch==='?'?'?':'');
          container.appendChild(sq);
        }
      });
    }

    function render(){
      const fen = game.fen();
      renderBoard(document.getElementById('boardA'), fen, false);
      renderBoard(document.getElementById('boardB'), fen, true);
    }

    document.getElementById('btnMove').onclick = ()=>{
      const san = document.getElementById('moveSan').value.trim();
      if(!san) return;
      const mv = game.move(san,{sloppy:true});
      if(mv){ lastMove = {from:mv.from,to:mv.to}; render(); }
      else alert('不正な手: '+san);
      document.getElementById('moveSan').value='';
    };

    document.getElementById('btnReset').onclick = ()=>{
      game = new Chess(); lastMove=null; render();
    };

    document.getElementById('seed').onchange = (e)=>{ seed = +e.target.value; render(); };

    render();
  </script></body>
</html>
